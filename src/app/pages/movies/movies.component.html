<div class="exploreflix-app">
  <!-- exploreflix Header -->
  <app-exploreflix-header
    [currentView]="currentView"
    [favoritesCount]="favorites.length"
    [watchlistCount]="watchlist.length"
    [searchTerm]="searchTerm"
    (viewChanged)="onViewChange($event)"
    (searchChanged)="onSearchChange($event)">
  </app-exploreflix-header>

  <!-- Main Content -->
  <main class="exploreflix-main">
    <!-- Hero Banner (solo en vista principal sin búsqueda) -->
    <app-hero-banner
      *ngIf="currentView === 'all' && !searchTerm && featuredMovie"
      [featuredMovie]="featuredMovie"
      [isFavorite]="isFavorite(featuredMovie)"
      (favoriteToggled)="toggleFavorite($event)">
    </app-hero-banner>

    <!-- Content Container -->
    <div class="content-container" [class.with-hero]="currentView === 'all' && !searchTerm && featuredMovie">

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando contenido...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="error-state">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>Algo salió mal</h3>
        <p>{{ error }}</p>
        <button mat-flat-button class="exploreflix-button-primary" (click)="retry()">
          Reintentar
        </button>
      </div>

      <!-- Content based on current view -->
      <div *ngIf="!loading && !error" class="exploreflix-content">

        <!-- Vista principal con categorías -->
        <div *ngIf="currentView === 'all'" class="main-content">

          <!-- Resultados de búsqueda -->
          <div *ngIf="searchTerm" class="search-results">
            <h2 class="section-title">Resultados para "{{ searchTerm }}"</h2>
            <div *ngIf="movies.length > 0; else noSearchResults" class="search-grid">
              <div
                class="search-movie-item"
                *ngFor="let movie of movies"
                [routerLink]="['/movie', movie.id]">
                <div class="search-movie-poster">
                  <img
                    *ngIf="movie.poster_path"
                    [src]="imageBase + movie.poster_path"
                    [alt]="movie.title"
                    loading="lazy">
                  <div *ngIf="!movie.poster_path" class="no-poster">
                    <mat-icon>movie</mat-icon>
                  </div>
                </div>
                <div class="search-movie-info">
                  <h4>{{ movie.title }}</h4>
                  <div class="search-movie-meta">
                    <span class="rating">
                      <mat-icon>star</mat-icon>
                      {{ movie.vote_average.toFixed(1) }}
                    </span>
                    <span class="year">{{ getReleaseYear(movie.release_date) }}</span>
                  </div>
                  <p class="overview" *ngIf="movie.overview">
                    {{ truncateOverview(movie.overview, 120) }}
                  </p>
                </div>
              </div>
            </div>

            <ng-template #noSearchResults>
              <div class="no-results">
                <mat-icon>search_off</mat-icon>
                <h3>No se encontraron resultados</h3>
                <p>Intenta con otros términos de búsqueda</p>
              </div>
            </ng-template>

            <!-- Paginación para búsqueda -->
            <div *ngIf="totalPages > 1" class="pagination">
              <button
                mat-stroked-button
                (click)="prevPage()"
                [disabled]="page === 1">
                <mat-icon>chevron_left</mat-icon>
                Anterior
              </button>
              <span class="page-info">{{ page }} / {{ totalPages }}</span>
              <button
                mat-stroked-button
                (click)="nextPage()"
                [disabled]="page === totalPages">
                Siguiente
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>

          <!-- Filas de películas por categoría -->
          <div *ngIf="!searchTerm" class="movie-rows">
            <app-movie-row
              *ngFor="let category of movieCategories"
              [title]="category.title"
              [movies]="category.movies"
              [favorites]="favorites"
              [watchlist]="watchlist"
              (favoriteToggled)="toggleFavorite($event)"
              (watchlistToggled)="toggleWatchlist($event)"
              (movieSelected)="onMovieSelected($event)">
            </app-movie-row>
          </div>
        </div>

        <!-- Vista de favoritos -->
        <div *ngIf="currentView === 'favorites'" class="favorites-content">
          <div class="section-header">
            <h2 class="section-title">Mi Lista</h2>
            <p class="section-subtitle">{{ favorites.length }} películas guardadas</p>
          </div>

          <div *ngIf="favorites.length > 0; else noFavorites" class="favorites-grid">
            <div
              class="favorite-item"
              *ngFor="let movie of favorites"
              [routerLink]="['/movie', movie.id]">
              <div class="favorite-poster">
                <img
                  *ngIf="movie.poster_path"
                  [src]="imageBase + movie.poster_path"
                  [alt]="movie.title"
                  loading="lazy">
                <div *ngIf="!movie.poster_path" class="no-poster">
                  <mat-icon>movie</mat-icon>
                </div>
                <div class="favorite-overlay">
                  <button
                    mat-icon-button
                    class="remove-favorite"
                    (click)="removeFavorite($event, movie)"
                    aria-label="Quitar de favoritos">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
              <div class="favorite-info">
                <h4>{{ movie.title }}</h4>
                <div class="favorite-meta">
                  <span class="rating">
                    <mat-icon>star</mat-icon>
                    {{ movie.vote_average.toFixed(1) }}
                  </span>
                  <span class="year">{{ getReleaseYear(movie.release_date) }}</span>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noFavorites>
            <div class="empty-state">
              <mat-icon>favorite_border</mat-icon>
              <h3>Tu lista está vacía</h3>
              <p>Agrega películas que te gusten para verlas más tarde</p>
              <button
                mat-flat-button
                class="exploreflix-button-primary"
                (click)="currentView = 'all'">
                Explorar películas
              </button>
            </div>
          </ng-template>
        </div>

        <!-- Vista de watchlist -->
        <div *ngIf="currentView === 'watchlist'" class="watchlist-content">
          <div class="section-header">
            <h2 class="section-title">Watchlist</h2>
            <p class="section-subtitle">{{ watchlist.length }} películas por ver</p>
          </div>

          <div *ngIf="watchlist.length > 0; else noWatchlist" class="watchlist-grid">
            <div
              class="watchlist-item"
              *ngFor="let movie of watchlist"
              [routerLink]="['/movie', movie.id]">
              <div class="watchlist-poster">
                <img
                  *ngIf="movie.poster_path"
                  [src]="imageBase + movie.poster_path"
                  [alt]="movie.title"
                  loading="lazy">
                <div *ngIf="!movie.poster_path" class="no-poster">
                  <mat-icon>movie</mat-icon>
                </div>
                <div class="watchlist-overlay">
                  <button
                    mat-icon-button
                    class="remove-watchlist"
                    (click)="removeWatchlist($event, movie)"
                    aria-label="Quitar de watchlist">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
              <div class="watchlist-info">
                <h4>{{ movie.title }}</h4>
                <div class="watchlist-meta">
                  <span class="rating">
                    <mat-icon>star</mat-icon>
                    {{ movie.vote_average.toFixed(1) }}
                  </span>
                  <span class="year">{{ getReleaseYear(movie.release_date) }}</span>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noWatchlist>
            <div class="empty-state">
              <mat-icon>bookmark_border</mat-icon>
              <h3>Tu watchlist está vacía</h3>
              <p>Guarda películas que quieras ver más tarde</p>
              <button
                mat-flat-button
                class="exploreflix-button-primary"
                (click)="currentView = 'all'">
                Explorar películas
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </main>
</div>
